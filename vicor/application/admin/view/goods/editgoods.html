<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>编辑商品</title>
    <link rel="stylesheet" href="/static/css/layui.css">
    <script src="__STATIC__/layui.js"></script>
    <style>
        form {
            padding-right: 20px;
            box-sizing: border-box;
        }

        form > img {
            width: 150px;
            height: auto;
        }

    </style>
</head>
<body>
<form class="layui-form" action="">
    <div class="layui-form-item">
        <label class="layui-form-label">所属分类</label>
        <div class="layui-input-block">
            <select name="cid" lay-verify="required">
                <option value=""></option>
                <!--volist标签通常用于查询数据集（select方法）的结果输出，通常模型的select方法返回的结果是一个二维数 组，可以直接使用volist标签进行输出。 在控制器中首先对模版赋值：Volist标签的name属性表示模板赋值的变量名称，因此不可随意在模板文件中改变。id表示当前的循环变量， 可以随意指定，但确保不要和name属性冲突-->
                {volist name="category" id="data"}
                <option value="{$data['cid']}" {$goods['cid']==$data['cid']?'selected':''}>{$data['cname']}</option>
                {/volist}
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">中文标题</label>
        <div class="layui-input-block">
            <input type="text" name="ctitle" required lay-verify="required" placeholder="请输入中文标题" autocomplete="off"
                   class="layui-input" value="{$goods['ctitle']}">
            <div class="layui-form-mid layui-word-aux">最多填写50个字符</div>
        </div>
        <input type="hidden" name="id" value="{$goods['id']}">
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">英文标题</label>
        <div class="layui-input-block">
            <input type="text" name="etitle" required lay-verify="required" placeholder="请输入英文标题" autocomplete="off"
                   class="layui-input" value="{$goods['etitle']}">
        </div>
    </div>
    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">商品描述</label>
        <div class="layui-input-block">
            <textarea name="gdes" placeholder="请输入商品描述" class="layui-textarea">{$goods['gdes']}</textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">商品价格</label>
        <div class="layui-input-block">
            <input type="text" name="price" required lay-verify="required" placeholder="请输入商品价格" autocomplete="off"
                   class="layui-input" value="{$goods['price']}">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">缩略图</label>
        <p>上传图片最佳尺寸170*170,最佳比例1:1</p>
        <button type="button" class="layui-btn" id="test1" name="gthumb">
            <i class="layui-icon">&#xe67c;</i>上传图片
        </button>
        <div class="layui-input-block">
            <input type="hidden" name="gthumb" value="{$goods['gthumb']}" id="hidden">
            <img src="{$goods['gthumb']}" alt="" id="review">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">轮播图</label>
        <div class="layui-input-block">
            <button type="button" class="layui-btn" id="gbanner">上传</button>
            <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
                预览图：最多可以上传五张
                <div class="layui-upload-list" id="demo2">
                    {volist name="arrbanner" id="vo"}
                    <img src="{$vo}" alt="" class="layui-upload-img">
                    {/volist}
                </div>
            </blockquote>
            <input type="hidden" value="{$goods['gbanner']}" id="gbanner_hidden" name="gbanner">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">商品颜色</label>
        <div class="layui-input-block">
            <div class="layui-input-inline" style="width: 120px;">
                <input type="text" value="{$goods['gcolor']}" placeholder="请选择颜色" class="layui-input"
                       id="test-form-input" name="gcolor">
            </div>
            <div class="layui-inline" style="left: -11px;">
                <div id="test-form"></div>
            </div>
        </div>
        <div class="layui-input-block">
            <div class="layui-input-inline" style="width: 120px;">
                <input type="text" value="{$goods['gcolor']}" placeholder="请选择颜色" class="layui-input"
                       id="test-form-input" name="gcolor">
            </div>
            <div class="layui-inline" style="left: -11px;">
                <div id="test-form"></div>
            </div>
        </div>
        <div class="layui-input-block">
            <div class="layui-input-inline" style="width: 120px;">
                <input type="text" value="{$goods['gcolor']}" placeholder="请选择颜色" class="layui-input"
                       id="test-form-input" name="gcolor">
            </div>
            <div class="layui-inline" style="left: -11px;">
                <div id="test-form"></div>
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">商品规格</label>
        <div class="layui-input-block">
            <input type="text" name="gspec" required lay-verify="required" placeholder="请输入商品规格" autocomplete="off"
                   class="layui-input" value="{$goods['gspec']}">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">商品种类</label>
        <div class="layui-input-block">
            <input type="text" name="gtype" required lay-verify="required" placeholder="请输入商品规格" autocomplete="off"
                   class="layui-input" value="{$goods['gtype']}">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">配送信息</label>
        <div class="layui-input-block">
            <input type="text" name="gdistribution" required lay-verify="required" placeholder="请输入商品配送信息"
                   autocomplete="off" class="layui-input" value="{$goods['gdistribution']}">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">上传状态</label>
        <div class="layui-input-block">
            <input type="checkbox" name="switch" lay-skin="switch" checked="{$goods['gstatus']==1?'true':''}">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">商品详情</label>
        <div class="layui-input-block">
            <button type="button" class="layui-btn" id="gdetail">
                <i class="layui-icon">&#xe67c;</i>上传图片
            </button>
            <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
                预览图：最多可以上传五张
                <div class="layui-upload-list" id="demo3">
                    {volist name="arrdetail" id="vo"}
                    <img src="{$vo}" alt="" title="{$goods['ctitle']}}" class="layui-upload-img">
                    {/volist}
                </div>
            </blockquote>
        </div>
        <input type="hidden" value="{$goods['gdetail']}" id="gdetail_hidden" name="gdetail">
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">商品库存</label>
        <div class="layui-input-block">
            <input type="text" name="gstock" required lay-verify="required" placeholder="请输入商品库存" autocomplete="off"
                   class="layui-input" value="{$goods['gstock']}">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="formDemo">立即提交</button>
            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
    </div>
</form>
<script>
    //Demo
    layui.use(['form', "upload", "layer", 'colorpicker', "table"], function () {
        let {form, upload, $, layer, colorpicker} = layui;
        let flagbanner = false, flagdetail = false;
        let arr=[];
        //单图片上传
        upload.render({
            elem: "#test1",//绑定元素
            url: "{:url('api/upload/upload')}",//上传接口
            accept: "images",
            size: 100,
            done: function (res, index, upload) {
                let {code, data, msg} = res;
                if (code == 0) {
                    let gthumb = $("#review");
                    arr.push(gthumb.attr("src"));
                    gthumb.attr("src", data.src);
                    $("#hidden").val(data.src);
                } else {
                    layer.msg("商品缩略图" + msg);
                }
            },
            error: function (index, upload) {
            }
        });
        //轮播图上传
        let banner_src = "";
        upload.render({
            elem: '#gbanner',
            url: '{:url("api/upload/upload")}',
            multiple: true,
            number: 5,
            size: 100,
            done: function (res) {
                let {code, msg, data} = res;
                let demo2 = $("#demo2");
                let gbanner = $("#gbanner_hidden");
                if (!flagbanner && code == 0) {
                    demo2.empty();//清空本地预览
                    gbanner.val("");//清空隐藏域中的值
                    flagbanner = true;
                }
                if (code == 0) {
                    banner_src += data.src + ",";
                    $("#gbanner_hidden").val(banner_src);
                    $('#demo2').append('<img src="' + data.src +  '" class="layui-upload-img">')
                }
            },
        });
        //颜色选择
        colorpicker.render({
            elem: '#test-form'
            , color: '#1c97f5'
            , done: function (color) {
                $('#test-form-input').val(color);
            }
        });
        let detail_src = "";
        upload.render({
            elem: "#gdetail",//绑定元素
            url: "{:url('api/upload/upload')}",//上传接口
            accept: "images",
            size: 100,
            multiple: true,
            number: 5,
            done: function (res) {
                let {code, msg, data} = res;
                let demo3 = $("#demo3");
                let gdetail = $("#gdetail_hidden");
                if (!flagbanner && code == 0) {
                    demo3.empty();//清空本地预览
                    gdetail.val("");//清空隐藏域中的值
                    flagdetail = true;
                }
                if (code == 0) {
                    detail_src += data.src + ",";
                    $("#gdetail_hidden").val(detail_src);
                    $('#demo3').append('<img src="' + data.src +  '" class="layui-upload-img">')
                }
            },
        })
        form.on('submit(formDemo)', function (data) {
            let {elem, form, field} = data;
            let index = layer.load(2);
            delete field.file;
            flagbanner && (field.gbanner = field.gbanner.slice(0,-1));
            flagdetail && (field.gdetail = field.gdetail.slice(0,-1));
            $.ajax({
                url: "{:url('admin/goods/updategoods')}",
                data: field,
                dataType: "json",
                type: "POST",
                success: function (res) {
                    let {code, msg} = res;
                    layer.close(index);
                    if(code==0){
                        var indexiframe = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                        parent.layer.close(indexiframe); //再执行关闭
                    }
                    let icon = code == 0 ? 6 : 5;
                    layer.msg(msg, {icon});
                }
            });
            arr.length && $.ajax({
                url: "{:url('api/upload/del')}",
                data:{img:arr},
                dataType:"json",
                type:"post",
                success:function(){

                }
            });
            return  false;
        });
    });
</script>
</body>
</html>